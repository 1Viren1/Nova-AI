<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova AI</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background:#212121; color:#ececec; }
#app { display:flex; flex-direction:column; height:100vh; }

#dev-bar { flex-shrink:0; background:#1a1a2e; padding:6px 16px; display:flex; align-items:center; gap:10px; font-size:11px; color:#aaa; border-bottom:1px solid #333; flex-wrap:wrap; }
#dev-bar button { color:#fff; border:1px solid #444; padding:3px 8px; border-radius:4px; font-size:11px; cursor:pointer; }
.btn-next { background:#c0392b; }
.btn-full { background:#555; }
.badge { background:#27ae60; color:#fff; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:700; }

.screen { display:none; flex:1; flex-direction:column; align-items:center; justify-content:center; padding:40px 24px; text-align:center; overflow-y:auto; }
.screen.active { display:flex; }
.screen h1 { font-size:22px; font-weight:700; margin-bottom:12px; }
.screen p { font-size:14px; color:#aaa; line-height:1.7; max-width:480px; }
.btn-main { margin-top:24px; background:linear-gradient(135deg,#a855f7,#6366f1); color:#fff; border:none; padding:12px 32px; border-radius:10px; font-size:15px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-block; }
.btn-main:hover { opacity:.9; }
.logo-icon { width:56px; height:56px; background:linear-gradient(135deg,#a855f7,#6366f1); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:26px; margin-bottom:20px; }

#screen-chat { display:none; flex-direction:column; padding:0; align-items:stretch; justify-content:flex-start; }
#chat-header { flex-shrink:0; padding:12px 20px; border-bottom:1px solid #2a2a2a; display:flex; align-items:center; gap:10px; }
.hlogo { width:30px; height:30px; background:linear-gradient(135deg,#a855f7,#6366f1); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:15px; }
#chat-header span { font-size:15px; font-weight:600; }
.model-pill { margin-left:auto; font-size:11px; background:#2a2a2a; padding:3px 10px; border-radius:12px; color:#888; }
#chat-body { flex:1; overflow-y:auto; padding:20px 0 10px; }
#chat-body::-webkit-scrollbar { width:5px; }
#chat-body::-webkit-scrollbar-thumb { background:#3a3a3a; border-radius:3px; }
#chat-footer { flex-shrink:0; padding:10px 20px; border-top:1px solid #2a2a2a; }
.input-hint { max-width:720px; margin:0 auto; font-size:12px; color:#555; text-align:center; }

.msg-wrap { padding:4px 20px; max-width:720px; margin:0 auto; width:100%; }
.user-bubble { background:#2f2f2f; border-radius:18px 18px 4px 18px; padding:10px 15px; display:inline-block; float:right; clear:both; max-width:75%; font-size:14px; line-height:1.6; }
.clearfix::after { content:''; display:table; clear:both; }
.ai-wrap { clear:both; }
.ai-label { font-size:11px; color:#777; margin-bottom:5px; display:flex; align-items:center; gap:6px; }
.ai-dot { width:16px; height:16px; background:linear-gradient(135deg,#a855f7,#6366f1); border-radius:50%; flex-shrink:0; }
.ai-text { font-size:14px; line-height:1.7; color:#ddd; }
.sponsored { display:inline-flex; align-items:center; background:#2a2a00; border:1px solid #555500; color:#aaaa44; font-size:10px; padding:1px 7px; border-radius:4px; margin-right:5px; vertical-align:middle; }
.options-wrap { display:flex; flex-direction:column; gap:8px; margin-top:14px; padding-bottom:8px; }
.opt-btn { background:#2a2a2a; border:1px solid #444; border-radius:10px; padding:10px 14px; text-align:left; color:#ccc; font-size:13px; cursor:pointer; transition:all .15s; line-height:1.4; width:100%; }
.opt-btn:hover:not(:disabled) { background:#333; border-color:#a855f7; color:#fff; }
.opt-btn:disabled { opacity:.4; cursor:default; }
.opt-num { display:inline-block; width:20px; height:20px; background:#3a3a3a; border-radius:50%; text-align:center; line-height:20px; font-size:11px; margin-right:8px; font-weight:700; color:#aaa; }
.typing { display:flex; gap:5px; align-items:center; padding:6px 0; }
.typing span { width:7px; height:7px; background:#666; border-radius:50%; animation:bounce 1.2s infinite; }
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
</style>
</head>
<body>
<div id="app">

  <!-- DEV BAR -->
  <div id="dev-bar">
    ğŸ”¬ Researcher Panel â€”
    Participant: <strong id="partdisplay">â€“</strong>
    Condition: <strong id="cdisplay">â€“</strong>
    <button class="btn-next" onclick="devReset()">â†º Next Participant</button>
    <button class="btn-full" onclick="fullReset()">âŸ³ Full Reset</button>
    <span class="badge">PROTOTYPE v5</span>
  </div>

  <!-- WELCOME -->
  <div id="screen-welcome" class="screen active">
    <div class="logo-icon">âœ¦</div>
    <h1>Nova AI</h1>
    <p>You're going to Turkey for Spring Break. This chatbot is going to help you with the travel planning.</p>
    <button class="btn-main" onclick="startChat()">Start â†’</button>
  </div>

  <!-- CHAT -->
  <div id="screen-chat">
    <div id="chat-header">
      <div class="hlogo">âœ¦</div>
      <span>Nova AI</span>
      <div class="model-pill">nova-3.5</div>
    </div>
    <div id="chat-body"></div>
    <div id="chat-footer"><div class="input-hint">Choose an option above to continue</div></div>
  </div>

  <!-- THANK YOU -->
  <div id="screen-thankyou" class="screen">
    <div style="max-width:480px;">
      <div style="font-size:36px;margin-bottom:16px;">ğŸ™</div>
      <h1>Thank You!</h1>
      <p style="margin-top:12px;">You've completed the chat session. Please now take a moment to fill in a short survey about your experience.<br><br>
      <strong style="color:#ccc;">Click the button below or follow the researcher's instructions.</strong></p>
      <a href="#" class="btn-main">Take the Survey â†’</a>
    </div>
  </div>

  <!-- DEBRIEF -->
  <div id="screen-debrief" class="screen">
    <div style="max-width:480px;">
      <div style="font-size:36px;margin-bottom:16px;">ğŸ”¬</div>
      <h1>Debrief</h1>
      <p style="margin-top:12px;">Thank you for participating. This was a research study examining how <strong style="color:#a855f7;">embedded advertising in AI responses</strong> affects user trust and behaviour.<br><br>
      You were randomly assigned to one of two conditions: an undisclosed advertisement, or a clearly disclosed advertisement.<br><br>
      Nova is a simulated AI â€” all responses were pre-scripted by the research team. Your responses help us understand the neuroscience of AI trust.<br><br>
      <strong style="color:#ccc;">If you have any questions, please speak to the researcher.</strong></p>
    </div>
  </div>

</div>
<script>
// â”€â”€ CONDITION LABELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// A = Undisclosed Ad, B = Disclosed Ad
const CONDITION_LABELS = { A:'A (Undisclosed)', B:'B (Disclosed)' };

// â”€â”€ AD TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AD_TEXT = {
  A: "Great base. For accommodation, Booking.com tends to have solid options there â€” good range across budgets and free cancellation on most listings. Prices vary a lot by area, so staying central is usually worth the slight premium.\n\nWhat's your rough budget per night?",
  B: "Great base. For accommodation, <span class='sponsored'>Sponsored</span> Booking.com has a solid range of options there â€” good variety across budgets and free cancellation on most listings. Prices vary by area, so staying central is usually worth the slight premium.\n\nWhat's your rough budget per night?"
};

// â”€â”€ SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCRIPT = [
  // Step 1 â€” Engagement
  {
    ai: "Turkey is a great choice for Spring Break! To help you plan, what kind of trip are you looking for?",
    opts: [
      "Culture and history â€” ruins, mosques, old cities",
      "Food and nightlife â€” local cuisine, rooftop bars, markets",
      "Beaches and relaxation â€” coast, sun, switching off"
    ]
  },
  // Step 2 â€” Engagement
  {
    ai: "Good choice. Turkey has a lot to offer on that front. Where are you thinking of basing yourself?",
    opts: [
      "Istanbul â€” I want the full city experience",
      "Cappadocia â€” the landscapes look incredible",
      "Antalya or the coast â€” somewhere warm by the sea"
    ]
  },
  // Step 3 â€” AD INSERTION POINT
  {
    ai: AD_TEXT,
    opts: [
      "Budget â€” under Â£40 per night",
      "Mid-range â€” Â£40 to Â£80 per night",
      "Flexible â€” comfort over cost"
    ]
  },
  // Step 4 â€” Contamination window
  {
    ai: "That's a reasonable range for Turkey â€” you'll find good options at that budget. A few things worth knowing: booking a few weeks out makes a noticeable difference in price, and reading recent reviews is more reliable than star ratings for smaller properties.\n\nWhat else would you like help planning?",
    opts: [
      "Getting around â€” flights, transport within Turkey",
      "What to eat â€” local food recommendations",
      "I think I have enough to go on, thanks"
    ]
  },
  // Step 5 â€” Contamination window
  {
    ai: "Turkey is very well connected â€” domestic flights between Istanbul, Cappadocia, and Antalya are frequent and affordable, often under Â£30 one way. Intercity buses are comfortable and even cheaper if you have more time.\n\nFor food, the essentials: fresh simit in the morning, a proper dÃ¶ner for lunch, and mezze in the evening. Street food is generally safe and very good.\n\nAnything else before you start planning?",
    opts: [
      "Yes â€” what are the must-see things to do?",
      "How much should I budget for the whole trip?",
      "No, that's everything â€” thanks Nova"
    ]
  },
  // Step 6 â€” Closure
  {
    ai: "You're all set! Turkey is a great choice for Spring Break â€” it's affordable, easy to get around, and has something for every kind of traveller.\n\nHope you have an amazing trip. Safe travels! ğŸŒ™",
    opts: [
      "Thanks Nova!",
      "Really helpful, appreciate it",
      "Great, I'll start booking"
    ]
  }
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let condition = '';
let step = 0;
let participantNum = 0;
let blockSequence = [];
let sessionData = {};

const DISENGAGE_STEPS = [3, 4];

// â”€â”€ BLOCK RANDOMISATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateBlockSequence(total) {
  const seq = [];
  for (let i = 0; i < total / 2; i++) {
    const block = ['A', 'B'];
    if (Math.random() > 0.5) block.reverse();
    seq.push(...block);
  }
  return seq;
}

function assignCondition() {
  if (blockSequence.length === 0) blockSequence = generateBlockSequence(40);
  condition = blockSequence[participantNum] || 'A';
  document.getElementById('cdisplay').textContent = CONDITION_LABELS[condition];
  document.getElementById('partdisplay').textContent = `${participantNum + 1}`;
}

// â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  ['screen-welcome','screen-chat','screen-thankyou','screen-debrief'].forEach(s => {
    const el = document.getElementById(s);
    el.style.display = 'none';
    el.classList.remove('active');
  });
  const t = document.getElementById(id);
  if (id === 'screen-chat') { t.style.display = 'flex'; t.style.flexDirection = 'column'; }
  else { t.style.display = 'flex'; t.classList.add('active'); }
}

// â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startChat() {
  assignCondition();
  sessionData = { participantNum: participantNum + 1, condition, startTime: new Date().toISOString(), responses: [], disengagementCount: 0, completed: false };
  document.getElementById('chat-body').innerHTML = '';
  step = 0;
  showScreen('screen-chat');
  setTimeout(() => nextStep(), 500);
}

function nextStep() {
  if (step >= SCRIPT.length) { setTimeout(() => showScreen('screen-thankyou'), 800); return; }
  const s = SCRIPT[step];
  setTimeout(() => {
    showTyping();
    setTimeout(() => {
      removeTyping();
      const text = typeof s.ai === 'object' ? s.ai[condition] : s.ai;
      addAI(text);
      if (s.opts) addOptions(s.opts, idx => {
        const isDisengage = DISENGAGE_STEPS.includes(step) && idx === 2;
        sessionData.responses.push({ step, optionIndex: idx, optionText: s.opts[idx], isDisengage });
        if (isDisengage) sessionData.disengagementCount++;
        addUser(s.opts[idx]);
        step++;
        nextStep();
      });
    }, 1100);
  }, 300);
}

function addAI(text) {
  const cb = document.getElementById('chat-body');
  const w = document.createElement('div');
  w.className = 'msg-wrap';
  w.innerHTML = `<div class="ai-wrap"><div class="ai-label"><div class="ai-dot"></div> Nova</div><div class="ai-text">${text.replace(/\n/g,'<br>')}</div></div>`;
  cb.appendChild(w); cb.scrollTop = cb.scrollHeight;
}

function addUser(text) {
  const cb = document.getElementById('chat-body');
  const w = document.createElement('div');
  w.className = 'msg-wrap clearfix';
  w.innerHTML = `<div class="user-bubble">${text}</div>`;
  cb.appendChild(w); cb.scrollTop = cb.scrollHeight;
}

function addOptions(opts, cb) {
  const body = document.getElementById('chat-body');
  const w = document.createElement('div');
  w.className = 'msg-wrap'; w.id = 'cur-opts';
  w.innerHTML = `<div class="options-wrap">${opts.map((o,i) => `<button class="opt-btn" onclick="selectOpt(${i})"><span class="opt-num">${i+1}</span>${o}</button>`).join('')}</div>`;
  w._cb = cb; body.appendChild(w); body.scrollTop = body.scrollHeight;
}

function selectOpt(i) {
  const w = document.getElementById('cur-opts');
  if (!w) return;
  const cb = w._cb;
  w.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
  w.id = 'used-opts';
  if (cb) cb(i);
}

function showTyping() {
  const cb = document.getElementById('chat-body');
  const w = document.createElement('div');
  w.id = 'typing-w'; w.className = 'msg-wrap';
  w.innerHTML = `<div class="ai-wrap"><div class="ai-label"><div class="ai-dot"></div> Nova</div><div class="typing"><span></span><span></span><span></span></div></div>`;
  cb.appendChild(w); cb.scrollTop = cb.scrollHeight;
}

function removeTyping() { const t = document.getElementById('typing-w'); if (t) t.remove(); }

// â”€â”€ RESEARCHER CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function devReset() {
  participantNum++;
  condition = ''; step = 0; sessionData = {};
  document.getElementById('cdisplay').textContent = 'â€“';
  document.getElementById('partdisplay').textContent = 'â€“';
  showScreen('screen-welcome');
}

function fullReset() {
  participantNum = 0; blockSequence = []; condition = ''; step = 0; sessionData = {};
  document.getElementById('cdisplay').textContent = 'â€“';
  document.getElementById('partdisplay').textContent = 'â€“';
  showScreen('screen-welcome');
}
</script>
</body>
</html>
